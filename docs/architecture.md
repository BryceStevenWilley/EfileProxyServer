# E-file Proxy Architecture

There's a glossary at the end with common e-filing jargon.

## ECF Architecture

ECF is the electronic court filing standard, an Oasis standard. We support ECF v4, and ECF v5.

ECF operates with several different Major Design Elements, or MDEs. These are just specific servers that talk to each other. It means that if you
want to search the court, you need to call an API at a different service. The details aren't super important from the EFSP perspective.

These MDEs include:

* the CourtRecordMDE: searching for cases and getting specific case information
* the FilingReviewMDE: where you actually make filings. Also can cancel filings, and get the status of specific filings
* the ServiceMDE: what you call to serve other parties in the case
* the FilingAssemblyMDE: this is the EFSP itself! It has to be able to accept incoming traffic from the EFM about the status of specific filings (if they are accepted, rejected, etc.)
* (ECF 5 only) CourtSchedulingMDE: lets you schedule court events, like Return dates, etc.
* (ECF 5 only) CourtPolicyMDE: gets specific information about each court, which you will need to make filings into with the FilingReviewMDE. In ECF 4, these API calls were a part of the FilingReviewMDE.

Notably, ECF only lays out what APIs you should call, and how to structure the information you pass to those APIs (i.e. they're parameters). It doesn't tell you what bits of information that you
need to provide. It does describe genericodes, which are a way for the EFM to tell the EFSP what values it accepts in particular XML element. However, certain values will always vary between implementations of EFMs. For example, Tyler Technologies makes you create Attorneys as a part of your firm before you can add them to cases. They have their own bespoke API for this, and through that API, give you a unique ID for those attorneys. The unique attorney ID is what you provide as the ID in the attorney part of a filing.

Hopefully this document is enough, and you should only have to refer to the standards when trying to discern what's different about ECF vs Tyler.

* [the ECF v4 standard](https://docs.oasis-open.org/legalxml-courtfiling/specs/ecf/v4.01/ecf-v4.01-spec/ecf-v4.01-spec.html)
* [the ECF v5 standard](https://docs.oasis-open.org/legalxml-courtfiling/ecf/v5.0/ecf-v5.0.html)

## Package layout

Java organizes its code by folders, called packages. It's encouraged to put your code in a package pertaining to the organization that is making the code, so all of our application code is in `edu.suffolk.litlab.efspserver`. Autogenerated code from the XML schemas and WSDLs end up in their namespaces, i.e. `urn:tyler:ecf:extensions:FilingServiceResponseMessage` will end up in `tyler.ecf.extensions`.

Code that is directly in the `edu.suffolk.litlab.efspserver` package (i.e. not in a subpackage) is code that is common to all of the other packages. This includes many plain-old-java-objecs (POJOs) that contain information we injest directly, and use as a common format before making filings to specific courts, to utility classes like `RandomString.java` and `StdLib.java`.

The `db` subpackage contains code that handles and is used to access the databases, including the Tyler codes database, `tyler_efm_codes`.

The `docassemble` subpackage contains code that reads in filing data from the docassemble platform, culminating in putting all of it in the `FilingInformation` object.

The `ecf4` subpackage contains all of the code used to file into ECF 4 courts. The `jeffnet` subpackage does the same for the Jefferson Parish court in Louisiana.

The `ecfcodes` subpackage extends on the `db` subpackage, and contains lots of specific code to handle reading and writing codes to the database.

The `services` subpackage contains all of the Jakarta API for RESTful Web Services (JAX-RS) code that provides our external facing REST API, and utility files that are JAX-RS and REST specific.

The `tyler` subpackage contains code specific to Tyler Technologies' implementations of ECF 4 and ECF 5.

### The Autogenerated code

Can be kinda dumb. My recommendation is to get a good search, and learn to read the XML schema instead, as the Java autogenerated code is often not enough to understand what goes where.

## The Network call mapping

TODO

## Making a Filing: the largest call

Rough outline: goes to the FilingReviewService, which delegates to the specific jurisdiction. Most jurisdictions are Tyler ECF4, which is `Ecf4Filer.java`. There, the same code is used if something is being checked (an extra API that we make to ensure that the Docassemble interview making the filing is structured well, without hitting the Tyler API, which gives poor error messages), filed, or served. The steps are:

* get any existing information, either from the API call itself, or from previous cases (with the CourtRecordMDE)
* piece together the ECF4 Filing message using the `EcfCaseTypeFactory`. For smaller pieces of ECF specific datatypes, we call the `EcfCourtSPecificSerializer`, and for each piece of information, there is a call to `tyler.TylerCodesSerializer` (used by both code in ECF4 and ECF5) that ensure that the semantics of what we pass in are correct according to the many checks and validations that Tyler makes use do, per court.
    * if anything is missing, wrong, or doesn't validate according to Tyler, we return detailed information about what pieces of information were missing, wrong, or optionally could be included. Ideally the docassmeble side could dynamically gather additional information, but that hasn't been implemented yet.
    * if everything necessary is present, we make the Filing with the FilingReviewMDE. TODO: what do we get back exactly?
* After we make the filing, we save enough of the filing information (user email, envelope ID from Tyler, etc.) such that when our FilingAssembleMDE gets the callback from Tyler's system, we can properly notify the user. These notifications can be a default, set per server making the filing, or can be a part of the filing API call data itself; the positive, negative, and neutral email templates.

TODO: write out all of the parameters that you can put in an email template.

## Glossary

* Jurisdiction: a legal unit of an independent court system. I.e. Texas is a jurisdiction, as well as Massachusetts. Although not currently present, states with multiple EFMs would be considered two different jurisdictions
* Location: mostly used to refer to a specific court or court-like entity in a jurisdiction. I.e. in Illinois, `adams` is the Adams county court system, and all filings would go to the `adams` location.
* ECF: Electronic Court Filing, the standard that we use to communicate with courts
* EFSP: Electronic Filing Service Provider: us / this piece of software. We provide the service directly to the end user, as opposed to the EFM
* EFM: Electronic Filing Manager: the piece of the architecture that sits between the EFSPs and the Courts. Tyler Technologies makes ours.
* CMS: Case Management System: The piece of software that courts use to manage cases. We don't directly communicate with the court CMSs, but we do generally need to know how they work
* MDE: Major Design Element: a component in ECF that serves a specific purpose, and hosts a number of APIs
* WSDL: Web service design language: a type of file in SOAP that describes an endpoint
* SOAP: Simple Object Access Protocol: the standard that we use to communicate with Tyler. Sends XML files back and forth, and those XML files are heavily pre-determined by a heavy API schema, contained in WSDLs
* XML: eXtensible Markup Language: a way of storing data in a structured way. Used in SOAP.
* JSON: JavaScript Object Notation: another way of storting data in a structured way. Much easier to read and edit by hand, and more flexible.
* JAX-RS: Jakarta API for RESTful Web Services: a java library / framework that lets up set up an external facing REST API. Uses a lot of annotations.

